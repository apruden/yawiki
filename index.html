<!DOCTYPE html>
<html manifest="yawiki.appcache">
  <!-- appcache works only when requesting form server. not for local file://. To delete goto: chrome://appcache-internals/ -->
  <!-- TODO: appcache is deprecated. Use ServiceWorkers instead. -->
  <head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/2.5.0/fuse.min.js"></script>
    <script src="https://cdn.rawgit.com/vkiryukhin/vkBeautify/master/vkbeautify.js"></script>
    <script src="https://cdn.rawgit.com/zewish/rmodal.js/master/dist/rmodal.min.js"></script>
    <script src="https://cdn.rawgit.com/knsv/mermaid/0.5.8/dist/mermaid.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/q.js/1.4.1/q.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/localforage/1.4.3/localforage.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="https://cdn.rawgit.com/zewish/rmodal.js/master/dist/rmodal.css"/>
    <link rel="stylesheet" href="https://cdn.rawgit.com/knsv/mermaid/0.5.8/dist/mermaid.forest.css"/>
    <style>
body {
  min-height: 2000px;
  padding-top: 70px;
}
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-collapse">
          <div class="col-md-9 pull-left">
            <from class="navbar-form" role="search">
            <input style="width:100%;" class="form-control" id="query" type="text" name="query" onkeyup="yawiki.search();">
            </from>
          </div>
          <ul class="nav navbar-nav">
            <li>
              <button class="btn btn-primary" type="button" onclick="yawiki.addPost();">add</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div id="container">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <button type="button" onclick="yawiki.loadMore();" class="btn btn-default">More</button>
        </div>
      </div>
    </div>
    <div id="modal" class="modal">
      <div class="modal-dialog animated">
        <div class="modal-content">
          <form class="form-horizontal" method="get">
            <div class="modal-header">
            </div>
            <div class="modal-body">
              <div id="editor" style="width:800px;height:500px;"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="button" onclick="yawiki.savePost();">Save</button>
              <button class="btn btn-default" type="button" onclick="yawiki.modal.close();">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <div id="cmdLineModal" class="modal">
      <div class="modal-dialog animated">
        <div class="modal-content">
          <form class="form-horizontal" method="get">
            <div class="modal-header">
            </div>
            <div class="modal-body" ng-app="cmdLineApp" ng-controller="cmdLineController">
              <textarea ng-model="cmdLine"></textarea>
              <div ng-repeat="arg in args">
                <input ng-model="arg.name">
                <input ng-model="arg.value">
                <button><i class="fa-times"></i></button>
              </div>
              <div ng-show="flag">
                <input ng-model="newArg.name">
                <input ng-model="newArg.value">
                <button class="btn btn-primary" ng-click="addNewArg()">add</button>
                <button class="btn" ng-click="cancelNewArg()">cancel</button>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="button" onclick="saveArticle();">Save</button>
              <button class="btn btn-default" type="button" onclick="modal.close();">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
var yawiki = (function(self) {
  var filesystem = null;
  var cs = null;
  var renderer = new marked.Renderer();
  var container = document.getElementById('container');
  var modal = new RModal(document.getElementById('modal'), {
    escapeClose: true
  });
  var data = [];
  var fuse = null;
  var curr = null;
  var i = 0;
  var editor = ace.edit('editor');
  var editors = {};
  var dal = new IDbDAL();

  function FsDAL() {
    function error(e) {
      console.error(e);
    }

    this.init = function() {
      var dfs = Q.defer();

      window.requestFileSystem = window.requestFileSystem || window.webkitRequestFileSystem;
      navigator.webkitPersistentStorage.requestQuota(5*1024*1024, function(grantedBytes) {
        window.requestFileSystem(PERSISTENT, grantedBytes, function(fs) {
          filesystem = fs;
          dfs.resolve();
        }, error);
      }, error);

      return dfs.promise;
    };

    this.listFiles = function() {
      var dirReader = filesystem.root.createReader();
      var entries = [];
      var d = Q.defer();

      var fetchEntries = function() {
        dirReader.readEntries(function(results) {
          if (results.length) {
            entries = entries.concat(results);
            fetchEntries();
          } else {
            d.resolve(entries.map(function(entry) { return entry.name; }));
          }
        });
      };

      fetchEntries();

      return d.promise;
    }

    this.loadFile = function(filename) {
      var d = Q.defer();

      filesystem.root.getFile(filename, {}, function(fileEntry) {
        fileEntry.file(function(file) {
          var reader = new FileReader();
          reader.onload = function(e) {
            d.resolve({id: filename, data: this.result});
          };
          reader.readAsText(file);
        });
      });

      return d.promise;
    }

    this.saveFile = function (filename, content) {
      var d = Q.defer();
      filesystem.root.getFile(filename, {create: true}, function(fileEntry) {
        fileEntry.createWriter(function(fileWriter) {
          fileWriter.onwriteend = function() {
            d.resolve();
          };
          var contentBlob = new Blob([content], {type: 'text/plain'});
          fileWriter.write(contentBlob);
        }, error);
      }, error);

      return d.promise;
    }

    this.deleteFile = function (filename) {
      var d = Q.defer();
      filesystem.root.getFile(filename, {create: false}, function(fileEntry) {
        fileEntry.remove(function() {
          d.resolve();
        });
      });

      return d.promise;
    }

    return this;
  }

  function IDbDAL() {
    this.init = function() {
      return Q.fcall(function() {
        return 0;
      });
    };

    this.listFiles = function() {
      return localforage.keys();
    };

    this.loadFile = function(k) {
      return localforage.getItem(k);
    };

    this.deleteFile = function(k) {
      return localforage.removeItem(k);
    };

    this.saveFile = function(k, content) {
      return localforage.setItem(k, {id:k, data: content, modified: new Date().getTime()});
    };

    return this;
  }

  function renderPost(k, content, pos) {
    var old = [];

    for (var e in editors) {
      old.push(e);
    }

    var mm = '<div id="' + k +'" class="panel panel-default">' +
      '<div class="panel-heading">' + new Date(parseInt(k)) +
      '<span class="pull-right"><a href="javascript:void(0);" onclick="yawiki.deletePost(\'' + k + '\');">delete</a>' + ' ' +
      '<a href="javascript:void(0);" onclick="yawiki.editPost(\'' + k + '\');">edit</a></span></div>' +
      '<div class="panel-body">' +
      marked(content, {renderer: renderer}) +
      '</div></div>';
    container.insertAdjacentHTML(pos || 'beforeend', mm);

    mermaid.init(undefined, '.graph');

    for (var x in editors) {
      if (old.indexOf(x) === -1) {
        var editor = ace.edit(x);
        editor.setReadOnly(true);
        editor.getSession().setMode('ace/mode/' + editors[x]);
      }
    }
  }

  function getPost(k) {
    data.some(function(post) {
      if(post.id === k) {
        renderPost(k, post.data);
        return true;
      }
    });
  }

  function saveTextAsFile(filename, content) {
    var textFileAsBlob = new Blob([content], { type:'text/plain' });
    var downloadLink = document.createElement('a');
    downloadLink.download = 'yawiki_' + filename + '.md';
    downloadLink.innerHTML = 'Download File';
    downloadLink.href = window.URL.createObjectURL(textFileAsBlob);
    downloadLink.click();
  }

  self.addPost = function () {
    curr = null;
    editor.setValue('');
    modal.open();
  };

  self.savePost = function () {
    var k = curr || new Date().getTime().toString();
    var content = editor.getValue();
    dal.saveFile(k, content).then(function() {
      reloadData();
      modal.close();
      saveTextAsFile(k, content);
    });
  };

  self.editPost = function (k) {
    curr = k;
    data.some(function(post) {
      if (post.id === k) {
        editor.setValue(post.data);
        modal.open();
      }
    });
  };

  self.loadMore = function() {
    data.slice(i, 10).forEach(function(post) {
      i++;
      getPost(post.id);
    });
  };

  self.deletePost = function  (k) {
    if(confirm('Delete?')) {
      dal.deleteFile(k).then(function() {
        reloadData();
      });
    }
  };

  function clearPosts() {
      while (container.firstChild) {
        container.removeChild(container.firstChild);
      }
  }

  self.search = function () {
    if(cs) {
      clearTimeout(cs);
    }

    cs = setTimeout(function() {
      clearPosts();
      var q = document.getElementById('query');

      if (q.value) {
        var res = fuse.search(q.value);
        res.forEach(function(d) {
          getPost(d.item.id);
        });

        document.title = '>> ' + q.value;
      } else {
        i = 0;
        self.loadMore();
        document.title = '>> ^^ <<';
      }
    }, 250);
  };

  function reloadData() {
    clearPosts();
    data = [];
    i = 0;
    dal.listFiles().then(function(keys) {
      Q.all(keys.map(function(k) {
        return dal.loadFile(k);
      })).then(function(entries) {
        entries.forEach(function(entry) {
          data.push(entry);
        });
        data.sort(function(a, b) { return (b.modified || 0) - (a.modified || 0); });
        fuse = new Fuse(data, {keys: ['data'], include: ['score'], threshold: 0.3, tokenize: true});
        self.loadMore();
      });
    });
  }

  function init() {
    document.title = '>> ^^ <<';
    mermaid.initialize({startOnLoad: false});
    renderer.code = function (code, language) {
      var id = new Date().getTime().toString();

      if(language === 'graph') {
        return '<div class="graph">'  + code +  '</div>';
      } else {
        var i = 1;

        while (id in editors) {
          id = (new Date().getTime() + i).toString();
          i++;
        }

        editors[id] = language;

        if(['xml', 'json', 'sql'].indexOf(language) !== -1) {
          code = vkbeautify[language](code);
        }

        code = code.replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&apos;');

        return '<div id="' + id + '" class="code" style="height:200px; width: 500px;">'  + code +  '</div>';
      }
    };

    editor.commands.addCommand({
      name: 'saveFile',
      bindKey: {
        win: 'Ctrl-S',
        sender: 'editor|cli'
      },
      exec: function(env, args, request) {
        self.savePost();
      }
    });
    editor.getSession().setMode('ace/mode/markdown');

    reloadData();
  }

  self.modal = modal;
  dal.init().then(init);

  self.cmdLineApp = angular.module('cmdLineApp').controller('cmdLineController', function($scope) {
        $scope.cmdLine = '';
        $scope.args = [];
        
        $scope.on('args', function() {
          var cmd = '';
          for(var k in $scope.args) {
            cmd += k + ' ' + $scope.args;
          }
          
          $scope.cmdLine = '';
        });
        
        $scope.showNewArg = function() {
          $scope.flag = true;
        };
        
        $scope.cancelNewArg = function() {
          $scope.flag = false;
          $scope.newArg = {};
        };
        
        $scope.addArg = function() {
          $scope.args.append(angular.copy($scope.newArg));
          $scope.newArg = {};
          $scope.flag = false;
        };
        
        $scope.delArgs = function(el) {
          var idx = $scope.args.indexOf(el);
          $scope.args.splice(idx);
        };
        
        $scope.parseArgs = function() {
          var re = /(\-\-?\S+)\s+([^"]\S+|\".*\")/g;
          var m = re.exec($scope.cmdLine);
          while(m != null) {
            $scope.args.push({m[1]: m[2]});
            m = re.exec($scope.cmdLine);
          }
        };  
      });

  return self;
})({} || yawiki);
    </script>
  </body>
</html>
