<!DOCTYPE html>
<html>
  <head>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/marked/0.3.6/marked.min.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js"></script>
    <script src="http://cdnjs.cloudflare.com/ajax/libs/fuse.js/2.5.0/fuse.min.js"></script>
    <script src="http://cdn.rawgit.com/vkiryukhin/vkBeautify/master/vkbeautify.js"></script>
    <script src="http://cdn.rawgit.com/zewish/rmodal.js/master/dist/rmodal.min.js"></script>
    <script src="http://cdn.rawgit.com/knsv/mermaid/0.5.8/dist/mermaid.min.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.7/angular.min.js"></script>
    <link rel="stylesheet" href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.5.2/animate.min.css">
    <link rel="stylesheet" href="http://cdn.rawgit.com/zewish/rmodal.js/master/dist/rmodal.css"/>
    <link rel="stylesheet" href="http://cdn.rawgit.com/knsv/mermaid/0.5.8/dist/mermaid.forest.css"/>
    <style>
body {
  min-height: 2000px;
  padding-top: 70px;
}
    </style>
  </head>
  <body>
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <div class="navbar-collapse">
          <div class="col-md-9 pull-left">
            <from class="navbar-form" role="search">
            <input style="width:100%;" class="form-control" id="query" type="text" name="query" onkeyup="search();">
            </from>
          </div>
          <ul class="nav navbar-nav">
            <li>
              <button class="btn btn-primary" type="button" onclick="addArticle();">add</button>
            </li>
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      <div class="row">
        <div class="col-md-12">
          <div id="container">
          </div>
        </div>
      </div>
      <div class="row">
        <div class="col-md-12">
          <button type="button" onclick="loadMore();" class="btn btn-default">More</button>
        </div>
      </div>
    </div>
    <div id="modal" class="modal">
      <div class="modal-dialog animated">
        <div class="modal-content">
          <form class="form-horizontal" method="get">
            <div class="modal-header">
            </div>
            <div class="modal-body">
              <div id="editor" style="width:800px;height:500px;"></div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="button" onclick="saveArticle();">Save</button>
              <button class="btn btn-default" type="button" onclick="modal.close();">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    
    <div id="cmdLineModal" class="modal">
      <div class="modal-dialog animated">
        <div class="modal-content">
          <form class="form-horizontal" method="get">
            <div class="modal-header">
            </div>
            <div class="modal-body" ng-app="cmdLineApp" ng-controller="cmdLineController">
              <textarea ng-model="cmdLine"></textarea>
              <div ng-repeat="arg in args">
                <input ng-model="arg.name">
                <input ng-model="arg.value">
                <button><i class="fa-times"></i></button>
              </div>
              <div ng-show="flag">
                <input ng-model="newArg.name">
                <input ng-model="newArg.value">
                <button class="btn btn-primary" ng-click="addNewArg()">add</button>
                <button class="btn" ng-click="cancelNewArg()">cancel</button>
              </div>
            </div>
            <div class="modal-footer">
              <button class="btn btn-primary" type="button" onclick="saveArticle();">Save</button>
              <button class="btn btn-default" type="button" onclick="modal.close();">Cancel</button>
            </div>
          </form>
        </div>
      </div>
    </div>
    <script>
      var renderer = new marked.Renderer();
      var container = document.getElementById('container');
      var modal = new RModal(document.getElementById('modal'), {
        escapeClose: true
      });
     var cmdLineModal = new RModal(document.getElementById('cmdLineModal'), {
        escapeClose: true
      });
      document.title = '>> ^^ <<';
      mermaid.initialize({startOnLoad: false});
      renderer.code = function (code, language) {
        var id = new Date().getTime().toString();

        if(language === 'graph') {
          return '<div class="graph">'  + code +  '</div>';
        } else {
          var i = 1;

          while (id in editors) {
            id = (new Date().getTime() + i).toString();
            i++;
          }

          editors[id] = language;

          if(['xml', 'json', 'sql'].indexOf(language) !== -1) {
            code = vkbeautify[language](code);
          }

          code = code.replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&apos;');

          return '<div id="' + id + '" class="code" style="height:200px; width: 500px;">'  + code +  '</div>';
        }
      };

      var keys = [];
      var editors = {};

      function renderArticle(k, content, pos) {
        var old = [];

        for (var e in editors) {
          old.push(e);
        }

        var mm = '<div id="' + k +'" class="panel panel-default">' +
          '<div class="panel-heading">' + new Date(parseInt(k)) +
          '<span class="pull-right"><a href="javascript:void(0);" onclick="deleteArticle(\'' + k + '\');">delete</a>' + ' ' +
          '<a href="javascript:void(0);" onclick="editArticle(\'' + k + '\');">edit</a></span></div>' +
          '<div class="panel-body">' +
          marked(content, {renderer: renderer}) +
          '</div></div>';
        container.insertAdjacentHTML(pos || 'beforeend', mm);

        mermaid.init(undefined, '.graph');

        for (var x in editors) {
          if (old.indexOf(x) === -1) {
            var editor = ace.edit(x);
            editor.setReadOnly(true);
            editor.getSession().setMode('ace/mode/' + editors[x]);
          }
        }
      }

      function addArticle() {
        curr = null;
        editor.setValue('');
        modal.open();
      }

      function getArticle(k) {
        var article  = localStorage[k];
        renderArticle(k, article);
      }

      function saveArticle() {
        var k = new Date().getTime().toString();
        var content = editor.getValue();
        localStorage[k] = content;
        keys.unshift(k);

        if(curr) {
          deleteArticle(curr, true, true);
        }

        reloadData();
        renderArticle(k, content, 'afterbegin');
        modal.close();
      }

      function editArticle(k) {
        curr = k;
        editor.setValue(localStorage[k]);
        modal.open();
      }

      function loadMore() {
        keys.slice(i, 10).forEach(function(k) {
          i++;
          getArticle(k);
        });
      }

      function deleteArticle(k, skipReload, skipConfirm) {
        if(skipConfirm || confirm('Delete?')) {
          delete localStorage[k];
          var el = document.getElementById(k);
          container.removeChild(el);

          if(!skipReload) {
            reloadData();
          }
        }
      }

      var cs = null;

      function search() {
        if(cs) {
          clearTimeout(cs);
        }

        cs = setTimeout(function() {
          while (container.firstChild) {
            container.removeChild(container.firstChild);
          }

          var q = document.getElementById('query');

          if (q.value) {
            var res = fuse.search(q.value);
            res.forEach(function(d) {
              getArticle(d.item.id);
            });

            document.title = '>> ' + q.value;
          } else {
            i = 0;
            loadMore();
            document.title = '>> ^^ <<';
          }
        }, 250);
      }

      function reloadData() {
        var data = [];
        keys = [];

        for (var k in localStorage) {
          keys.push(k);
          data.push({id: k, data: localStorage[k]});
        }

        keys.sort().reverse();
        fuse = new Fuse(data, {keys: ['data'], include: ['score'], threshold: 0.3, tokenize: true});
      }

      function init() {
        reloadData();
        loadMore();
      }

      var fuse = null;
      var curr = null;
      var i = 0;
      var editor = ace.edit('editor');
      editor.commands.addCommand({
        name: 'saveFile',
        bindKey: {
          win: 'Ctrl-S',
          sender: 'editor|cli'
        },
        exec: function(env, args, request) {
          saveArticle();
        }
      });
      
      init();
     
      var cmdLineApp = angular.module('cmdLineApp').controller('cmdLineController', function($scope) {
        $scope.cmdLine = '';
        $scope.args = [];
        
        $scope.on('args', function() {
          var cmd = '';
          for(var k in $scope.args) {
            cmd += k + ' ' + $scope.args;
          }
          
          $scope.cmdLine = '';
        });
        
        $scope.showNewArg = function() {
          $scope.flag = true;
        };
        
        $scope.cancelNewArg = function() {
          $scope.flag = false;
          $scope.newArg = {};
        };
        
        $scope.addArg = function() {
          $scope.args.append(angular.copy($scope.newArg));
          $scope.newArg = {};
          $scope.flag = false;
        };
        
        $scope.delArgs = function(el) {
          var idx = $scope.args.indexOf(el);
          $scope.args.splice(idx);
        };
        
        $scope.parseArgs = function() {
          var re = /(\-\-?\S+)\s+([^"]\S+|\".*\")/g;
          var m = re.exec($scope.cmdLine);
          while(m != null) {
            $scope.args.push({m[1]: m[2]});
            m = re.exec($scope.cmdLine);
          }
        };  
      });
    </script>
  </body>
</html>
